trigger:
  branches:
    include:
      - main
pool:
  name: Default

variables:
  AWS_REGION: 'us-east-1'
  TF_VERSION: '1.4.0'
  TFLINT_VERSION: '0.46.1'
  TFSEC_VERSION: '1.28.1'

stages:
- stage: TerraformCI
  displayName: "Terraform CI/CD"
  jobs:
  - job: Terraform
    displayName: "Terraform Lint, Security Check, and Deploy"
  

    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Login via Azure CLI"
      inputs:
        azureSubscription: 'MyAzureConnection'
        scriptType: pscore
        scriptLocation: inlineScript
        inlineScript: echo "Logged in successfully"
        

    - script: |
        curl -o terraform.zip https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
        unzip terraform.zip
        sudo mv terraform /usr/local/bin/
        terraform -version
      displayName: 'Install Terraform*****'

    - script: terraform init
      displayName: 'Terraform Init'
      workingDirectory: ./app-gateway

    - script: terraform validate
      displayName: 'Terraform Validate'
      workingDirectory: ./app-gateway

    - script: terraform plan -out=tfplan
      displayName: 'Terraform Plan'
      workingDirectory: ./app-gateway

    - script: terraform apply -auto-approve tfplan
      displayName: 'Terraform Apply'
      condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
      workingDirectory: ./app-gateway
