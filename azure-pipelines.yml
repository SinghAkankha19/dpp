trigger:
  branches:
    include:
      - main

pool:
  name: Default

variables:
  AWS_REGION: 'us-east-1'
  TF_VERSION: '1.4.0'
  TFLINT_VERSION: '0.46.1'
  TFSEC_VERSION: '1.28.1'

stages:
- stage: TerraformCI
  displayName: "Terraform CI"
  jobs:
    - job: TerraformPlan
      displayName: "Terraform Init, Validate, and Plan"
      pool:
        vmImage: ubuntu-latest

      steps:
        - checkout: self

        - task: AzureCLI@2
          displayName: "Login via Azure CLI"
          inputs:
            azureSubscription: 'MyAzureConnection'
            scriptType: pscore
            scriptLocation: inlineScript
            inlineScript: echo "Logged in successfully"

        - script: |
            curl -o terraform.zip https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
            unzip terraform.zip
            sudo mv terraform /usr/local/bin/
            terraform -version
          displayName: 'Install Terraform'

        - script: terraform init
          displayName: 'Terraform Init'
          workingDirectory: ./app-gateway

        - script: terraform validate
          displayName: 'Terraform Validate'
          workingDirectory: ./app-gateway

        - script: terraform plan -out=tfplan
          displayName: 'Terraform Plan'
          workingDirectory: ./app-gateway

        - publish: ./app-gateway/tfplan
          artifact: tfplan-artifact

# ---------------------------
- stage: TerraformApply
  displayName: "Terraform Apply with Approval"
  dependsOn: TerraformCI
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')

  jobs:
    - deployment: TerraformApplyJob
      displayName: "Terraform Apply"
      environment: approval-env  # Add approval here via DevOps UI
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: tfplan-artifact

              - checkout: self

              - task: AzureCLI@2
                displayName: "Login via Azure CLI"
                inputs:
                  azureSubscription: 'MyAzureConnection'
                  scriptType: pscore
                  scriptLocation: inlineScript
                  inlineScript: echo "Logged in successfully"

              - script: |
                  curl -o terraform.zip https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
                  unzip terraform.zip
                  sudo mv terraform /usr/local/bin/
                  terraform -version
                displayName: 'Install Terraform'

              - script: terraform apply -auto-approve tfplan
                displayName: 'Terraform Apply'
                workingDirectory: ./app-gateway
